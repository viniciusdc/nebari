

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="652c90">
  <script src="../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>Installation &#8212; QHub Code as Infrastructure.</title>
    <link rel="stylesheet" href="../../_static/material.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

  
   

<style>
  .md-header, .md-tabs {background-color: #653c90}
</style>
  </head>
  <body dir=ltr
        data-md-color-primary=652c90 data-md-color-accent=light-yellow>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#docs/gcp/installation" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../index.html" title="QHub Code as Infrastructure."
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">QHub</span>
          <span class="md-header-nav__topic"> Installation </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../search.html" method="GET" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/Quansight/qhub" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    QHub
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../../"versions.json"",
        target_loc = "../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">QHub Code as Infrastructure.</a></li>
            
            <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">QHub Home</a></li>
            
            <li class="md-tabs__item"><a href="https://pypi.org/project/qhub/" class="md-tabs__link">Pypi</a></li>
            
            <li class="md-tabs__item"><a href="../faqs.html" class="md-tabs__link">FAQ</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../index.html" title="QHub Code as Infrastructure." class="md-nav__button md-logo">
      
        <img src="../../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../index.html"
       title="QHub Code as Infrastructure.">QHub</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/Quansight/qhub" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    QHub
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../step-by-step-walkthrough.html" class="md-nav__link">Step-by-Step QHub Cloud Deployment</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../do/configuration.html" class="md-nav__link">Configuration</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../do/configuration.html#full-configuration-example" class="md-nav__link">Full Configuration Example</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../do/configuration.html#initializing-repository" class="md-nav__link">Initializing Repository</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../faqs.html" class="md-nav__link">Frequently Asked Questions (FAQ)</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#docs-gcp-installation--page-root" class="md-nav__link">Installation</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#environment-variables" class="md-nav__link">Environment Variables</a>
        </li>
        <li class="md-nav__item"><a href="#bootstrapping" class="md-nav__link">Bootstrapping</a>
        </li>
        <li class="md-nav__item"><a href="#kubernetes-installation" class="md-nav__link">Kubernetes Installation</a>
        </li>
        <li class="md-nav__item"><a href="#checking-the-cluster-via-cli" class="md-nav__link">Checking the Cluster via CLI</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#dns" class="md-nav__link">DNS</a>
        </li>
        <li class="md-nav__item"><a href="#authentication" class="md-nav__link">Authentication</a>
        </li>
        <li class="md-nav__item"><a href="#qhub-installation" class="md-nav__link">QHub Installation</a>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../../_sources/docs/gcp/installation.md.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  
<h1 id="docs-gcp-installation--page-root">Installation<a class="headerlink" href="#docs-gcp-installation--page-root" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://www.terraform.io/downloads.html">Terraform installation directions</a>.</p>
<p>The following steps can be automated with
<code class="docutils literal notranslate"><span class="pre">scripts/00-guided-install.sh</span></code>. When the script prompts the user for
pressing <code class="docutils literal notranslate"><span class="pre">[enter]</span></code> there is an associated user action required.</p>

<h2 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h2>
<p>This deployment along with the GitHub Actions assumes several
environment variables are present.</p>
<p>Since we are using Github Actions for Continuous Deployment we require
a <a class="reference external" href="https://github.blog/2013-05-16-personal-api-tokens/">personal api token</a>.
This token is required to have access to the <strong>full repo</strong> and <strong>workflows</strong>.
Set <code class="docutils literal notranslate"><span class="pre">REPOSITORY_ACCESS_TOKEN</span></code> to the token value. This token is required because
as of github actions v2 <code class="docutils literal notranslate"><span class="pre">GITHUB_TOKEN</span></code> cannot trigger github actions.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">REPOSITORY_ACCESS_TOKEN</span></code></p></li>
</ul>
<p>Google Cloud deployment requires the project id and service account
credentials.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GOOGLE_CREDENTIALS</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PROJECT_ID</span></code></p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">GOOGLE_CREDENTIALS</span></code> must be the contents of the <code class="docutils literal notranslate"><span class="pre">json</span></code> credentials
file with sufficient permissions to create all resources on the
cluster. Detailed instructions on <a class="reference external" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys">creating service accounts can be
found
here</a>. <code class="docutils literal notranslate"><span class="pre">PROJECT_ID</span></code>
is a short string of around 32 characters that defines your project
uniquely. The service account will need <code class="docutils literal notranslate"><span class="pre">Project-&gt;Editor</span></code>
permissions. In addition you will need to enable the <code class="docutils literal notranslate"><span class="pre">Cloud</span> <span class="pre">Resource</span> <span class="pre">Manager</span> <span class="pre">API</span></code>. The deployment will fail without the api enabled.</p>


<h2 id="bootstrapping">Bootstrapping<a class="headerlink" href="#bootstrapping" title="Permalink to this headline">¶</a></h2>
<p>Terraform is used for all deployments of infrastructure as well as
Kubernetes state. In order to use Infrastructure as code with
repositories we need somewhere to store the terraform state in between
invocations. The default is to store the state in the local git
repository which is not ideal for several reasons including checking
in secrets to the repository. Each provider has a different best way
to deploy the infrastructure.</p>
<p>Google Cloud storage provides an s3 compatible storage with additional
benefits such as built in file locking.</p>
<p>Finally to bootstrap run the following commands</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> terraform-state
terraform init
terraform apply <span class="c1"># reply yes</span>
</pre></div>
</div>


<h2 id="kubernetes-installation">Kubernetes Installation<a class="headerlink" href="#kubernetes-installation" title="Permalink to this headline">¶</a></h2>
<p>Once the setup has been bootstrapped we recommend letting GitHub
actions take over from this point on. This means setting the
environment variables mentioned above as secrets. One additional
benefit of this approach. Is that After bootstrapping the terraform
state no one needs to have access to the credentials (only github
actions). If you would like to perform the installation locally we
follow the same terraform deployment steps.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> infrastructure
terraform init
terraform apply -target<span class="o">=</span>module.kubernetes -target<span class="o">=</span>module.kubernetes-initialization -target<span class="o">=</span>module.kubernetes-ingress <span class="c1"># reply yes</span>
</pre></div>
</div>
<p>Notice a pattern here with terraform deployments? <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">init</span></code> +
<code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">apply</span></code> should be enough to maintain the entire
cluster. About 15 minutes after these commands or the GitHub Action
starting you will have a working jupyterhub cluster.</p>


<h2 id="checking-the-cluster-via-cli">Checking the Cluster via CLI<a class="headerlink" href="#checking-the-cluster-via-cli" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Install the AWS CLI:
https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html</p></li>
<li><p>Update the kubeconfig:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws eks --region us-west-2  update-kubeconfig --name jupyterhub-aws-dev
</pre></div>
</div>
<p>Now you can run <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> and <code class="docutils literal notranslate"><span class="pre">helm</span></code> commands to know about your cluster and deployments.
Here are some useful commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl get pods -n dev
kubectl get nodes -n dev
helm list -n dev
</pre></div>
</div>



<h1 id="dns">DNS<a class="headerlink" href="#dns" title="Permalink to this headline">¶</a></h1>
<p>The DNS is handled by Cloudflare. To point the cloudflare subdomain
<code class="docutils literal notranslate"><span class="pre">jupyter.aws</span></code>(.qhub.dev) to your application, first get the CNAME of
the Load balancer. You can get the CNAME of the load balancer via the
following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl get svc -n dev
</pre></div>
</div>
<p>This lists all the running services in the Kubernetes cluster. There would be a service
of type <code class="docutils literal notranslate"><span class="pre">LoadBalancer</span></code>, listed in the output of the above command. The CNAME would
be mentioned right next to it.</p>
<p>Now go to the DNS section of the Cloudflare’s dashboard and create an <code class="docutils literal notranslate"><span class="pre">CNAME</span></code> record for the
subdomain <code class="docutils literal notranslate"><span class="pre">jupyter.aws</span></code>(.qhub.dev) and paste the CNAME of the load balancer in the content
column and click on the proxy status to change the value to DNS only.</p>


<h1 id="authentication">Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h1>
<p>Currently the authentication is being performed by Github OAuth. Instructions to come on.</p>


<h1 id="qhub-installation">QHub Installation<a class="headerlink" href="#qhub-installation" title="Permalink to this headline">¶</a></h1>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> infrastructure
terraform init
terraform apply <span class="c1"># reply yes</span>
</pre></div>
</div>



          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright .
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 2.4.4.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>